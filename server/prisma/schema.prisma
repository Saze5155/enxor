// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String
  role      Role     @default(PLAYER)
  
  targetedArticles Article[] @relation("ArticleTargets")

  characters Character[]
  campaigns  Campaign[] @relation("CampaignPlayers")
  createdEnemies EnemyType[] @relation("CreatedEnemies")
  createdNPCs NPC[] @relation("CreatedNPCs")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Character {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  campaignId String?
  campaign   Campaign? @relation(fields: [campaignId], references: [id])
  
  // Infos de Base
  name      String
  race      String?
  subRace   String?
  class     String?
  subClass  String?
  level     Int      @default(1)
  background String?
  alignment String?
  xp        Int      @default(0)
  
  // Statistiques (stockées en JSON String pour SQLite)
  stats     String   @default("{\"strength\":10,\"dexterity\":10,\"constitution\":10,\"intelligence\":10,\"wisdom\":10,\"charisma\":10}")
  statsOverrides String @default("{}") // Surcharges manuelles (Force, Dex, PV Max, CA...)

  // Combat
  hpCurrent Int      @default(10)
  hpMax     Int      @default(10)
  tempHp    Int      @default(0)
  ac        Int      @default(10)
  initiative Int     @default(0)
  speed     Int      @default(30)
  
  hitDiceMax     String? // "1d10"
  hitDiceUsed    Int      @default(0)
  
  deathSavesSuccess Int @default(0)
  deathSavesFailures Int @default(0)
  
  customCombatLabel String @default("Notes Combat")
  customCombatValue String?

  // Données Complexes (JSON String)
  // Stockage JSON pour SQLite : simple et flexible
  skills    String   @default("[]") // Liste des compétences et expertises
  proficiencies String @default("{\"armor\":[],\"weapons\":[],\"tools\":[],\"languages\":[]}")
  wallet    String   @default("{\"cp\":0,\"sp\":0,\"ep\":0,\"gp\":0,\"pp\":0}") // PO, PA, PC...
  spellSlots String  @default("{\"1\":{\"max\":0,\"used\":0},\"2\":{\"max\":0,\"used\":0},\"3\":{\"max\":0,\"used\":0},\"4\":{\"max\":0,\"used\":0},\"5\":{\"max\":0,\"used\":0},\"6\":{\"max\":0,\"used\":0},\"7\":{\"max\":0,\"used\":0},\"8\":{\"max\":0,\"used\":0},\"9\":{\"max\":0,\"used\":0}}") // Emplacements de sorts
  
  // Relations
  inventory CharacterItem[]
  spells    CharacterSpell[]
  features  CharacterFeature[]
  combatParticipants CombatParticipant[]
  
  // Meta
  avatarUrl String?
  notes     String?
  backstory String?
  
  traits    String? // Personnalité
  ideals    String?
  bonds     String?
  flaws     String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CharacterItem {
  id          String    @id @default(uuid())
  characterId String
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  
  itemId      String?   // Référence optionnelle à un ID d'objet standard
  name        String
  quantity    Int       @default(1)
  isEquipped  Boolean   @default(false)
  equippedSlot String?  // main_hand, off_hand, armor, head, feet, accessory_1, etc.
  type        String?   // weapon, armor, potion, etc.
  
  // Propriétés spécifiques
  damage      String?   // Dégâts (ex: "1d8", "2d6")
  damage2     String?   // Dégâts secondaires (ex: "1d10")
  properties  String?   // Propriétés (ex: "Finesse, Légère")
  
  notes       String?
}

model CharacterSpell {
  id          String    @id @default(uuid())
  characterId String
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  
  spellId     String?   // Référence optionnelle à un ID de sort standard
  name        String
  level       Int
  isPrepared  Boolean   @default(false)
  
  // Propriétés spécifiques (JSON)
  properties  String?   // École, Temps, Portée, Composantes, etc.
}

model CharacterFeature {
  id          String    @id @default(uuid())
  characterId String
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  
  name        String
  source      String?   // Race, Classe, Don
  levelObtained Int?
  
  description String
  
  // Gestion des utilisations
  usesMax     Int?
  usesCurrent Int?
  resetType   String?   // short_rest, long_rest
}

enum Role {
  MJ
  PLAYER
}

model Category {
  id        String    @id @default(uuid())
  name      String    @unique
  icon      String?
  articles  Article[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Article {
  id          String     @id @default(uuid())
  title       String
  content     String
  visibility  Visibility @default(DRAFT)
  
  categoryId  String
  category    Category   @relation(fields: [categoryId], references: [id])
  
  tags        Tag[]
  
  // New: Targeted visibility
  targets     User[]     @relation("ArticleTargets")
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model Tag {
  id        String    @id @default(uuid())
  name      String    @unique
  articles  Article[]
}

enum Visibility {
  DRAFT
  PUBLIC
  PARTIAL
  SECRET
  TARGETED
}

model Campaign {
  id        String   @id @default(uuid())
  name      String
  gmId      String
  
  // Relations
  players   User[]   @relation("CampaignPlayers")
  characters Character[]
  enemyInstances EnemyInstance[]
  combats   Combat[]

  isSessionOpen Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- SYSTÈME D'ENNEMIS ---

model EnemyType {
  id String @id @default(uuid())
  
  // Identité
  name     String
  category String // "creature_basique", "archetype_classe", "creature_custom"
  
  // Infos D&D 5e
  creatureType String // "Aberration", "Bête", etc.
  subType      String?
  size         String // "TP", "P", "M", "G", "TG", "Gig"
  alignment    String 
  
  // Données Techniques (JSON)
  stats             String @default("{}") // CA, PV formule, Vitesses, Caracs, Skills, Saves...
  actions           String @default("[]") // Attaques et actions spéciales
  reactions         String @default("[]")
  legendaryActions  String @default("[]")
  specialAbilities  String @default("[]")
  
  // Métadonnées Classe/Race (pour les PNJ avec classe)
  classInfo         String @default("{}") // classe, race, niveau default...
  
  // Encyclopédie & Lore (JSON)
  encyclopedia      String @default("{}") // description courte/longue, habitat, tactiques...
  imageUrl          String?
  
  // Relations & Meta
  source    String @default("Homebrew")
  tags      String @default("[]") // JSON array of strings
  
  authorId  String?
  author    User?   @relation("CreatedEnemies", fields: [authorId], references: [id])
  
  instances EnemyInstance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EnemyInstance {
  id String @id @default(uuid())
  
  enemyTypeId String
  enemyType   EnemyType @relation(fields: [enemyTypeId], references: [id])
  
  // Personnalisation
  name      String // Nom personnalisé ou identique au type
  isUnique  Boolean @default(false)
  isBoss    Boolean @default(false)
  
  // État Combat
  hpCurrent Int
  hpMax     Int
  tempHp    Int @default(0)
  status    String @default("vivant") // vivant, mort, inconscient, fuite
  conditions String @default("[]") // JSON list of conditions
  
  // Surcharges (JSON)
  statsOverrides String @default("{}") // Modifications de stats par rapport au Type
  
  // Tracking
  campaignId String?
  campaign   Campaign? @relation(fields: [campaignId], references: [id])
  combatParticipants CombatParticipant[]
  
  notes     String? // Notes privées MJ
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- SYSTÈME DE PNJ ---

model NPC {
  id          String   @id @default(uuid())
  name        String
  role        String   // Rôle du PNJ (Marchand, Noble, Garde, etc.)
  race        String   // Race du PNJ
  class       String?  // Classe si applicable
  level       Int      @default(1)
  
  // Apparence
  age         String?
  appearance  String?  // Description physique
  
  // Personnalité
  personality String?  // Traits de personnalité
  ideals      String?
  bonds       String?
  flaws       String?
  
  // Background
  background  String?  // Histoire du PNJ
  occupation  String?
  location    String?  // Où se trouve le PNJ
  
  // Stats (optionnel, pour PNJ combattants) - JSON
  stats       String?  // { force, dex, con, int, sag, cha, ac, hp }
  
  // Relations
  faction     String?
  allies      String?
  enemies     String?
  
  // Détails supplémentaires
  quirks      String?  // Particularités/Tics
  voice       String?  // Façon de parler
  goals       String?  // Objectifs actuels
  
  // Méta
  isImportant Boolean  @default(false) // PNJ important/récurrent
  isAlive     Boolean  @default(true)
  notes       String?  // Notes du MJ
  imageUrl    String?
  
  authorId    String
  author      User     @relation("CreatedNPCs", fields: [authorId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// --- SYSTÈME DE COMBAT ---

model Combat {
  id                String   @id @default(uuid())
  campaignId        String
  campaign          Campaign @relation(fields: [campaignId], references: [id])
  
  dateDebut         DateTime @default(now())
  dateFin           DateTime?
  statut            String   // "en_cours" | "terminé" | "pause"
  roundActuel       Int      @default(1)
  tourActuelIndex   Int      @default(0)
  
  participants      CombatParticipant[]
  ordreInitiative   String   @default("[]") // JSON array of participant IDs in order
  parametres        String   @default("{}") // JSON: { surprise: boolean, difficulte: string }
  historiqueActions String   @default("[]") // JSON array of actions
  statistiques      String   @default("{}") // JSON: combat stats
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([campaignId])
  @@index([statut])
}

model CombatParticipant {
  id                  String  @id @default(uuid())
  combatId            String
  combat              Combat  @relation(fields: [combatId], references: [id], onDelete: Cascade)
  
  type                String  // "joueur" | "ennemi" | "pnj"
  nom                 String
  
  // Références
  characterId         String?
  character           Character? @relation(fields: [characterId], references: [id])
  enemyInstanceId     String?
  enemyInstance       EnemyInstance? @relation(fields: [enemyInstanceId], references: [id])
  
  // Stats de combat
  initiative          Int?     // Nullable until rolled
  pvActuels           Int
  pvMax               Int
  pvTemporaires       Int      @default(0)
  ca                  Int
  
  // État
  conditions          String   @default("[]") // JSON array
  effetsTemporaires   String   @default("[]") // JSON array
  position            String?  // JSON: { x: number, y: number }
  
  estConscient        Boolean  @default(true)
  mort                Boolean  @default(false)
  concentreSur        String?  // Sort ID ou nom
  
  // Statistiques individuelles
  degatsInfliges      Int      @default(0)
  degatsRecus         Int      @default(0)
  soinsProdigues      Int      @default(0)
  sortsLances         Int      @default(0)
  jetsCritiques       Int      @default(0)
  jetsEchecsCritiques Int      @default(0)
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@index([combatId])
  @@index([characterId])
  @@index([enemyInstanceId])
}

